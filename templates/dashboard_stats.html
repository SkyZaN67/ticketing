{% extends "base.html" %}
{% block content %}

<h2 class="mb-4 text-primary">üìä Dashboard des Statistiques</h2>

<!-- üìÖ Filtres P√©riodes -->
<form method="get" class="row mb-4 g-3 align-items-end">
  <div class="col-md-3">
    <label for="periode" class="form-label">P√©riode rapide :</label>
    <select name="periode" class="form-select" onchange="this.form.submit()">
      <option value="7jours" {% if periode == '7jours' %}selected{% endif %}>7 derniers jours</option>
      <option value="mois_dernier" {% if periode == 'mois_dernier' %}selected{% endif %}>Mois dernier</option>
      <option value="tous" {% if periode == 'tous' %}selected{% endif %}>Tout</option>
    </select>
  </div>
  <div class="col-md-3">
    <label for="date_debut" class="form-label">Date d√©but :</label>
    <input type="date" id="date_debut" name="date_debut" class="form-control" value="{{ request.args.get('date_debut', '') }}">
  </div>
  <div class="col-md-3">
    <label for="date_fin" class="form-label">Date fin :</label>
    <input type="date" id="date_fin" name="date_fin" class="form-control" value="{{ request.args.get('date_fin', '') }}">
  </div>
  <div class="col-md-3 d-flex align-items-end">
    <button type="submit" class="btn btn-primary w-100">Filtrer par dates</button>
  </div>
</form>

<!-- üî• Graphiques -->
<div class="row">
  <div class="col-md-6 mb-4">
    <div class="card shadow-sm p-3">
      <h5 class="text-center">üõ†Ô∏è R√©partition des Tickets</h5>
      <canvas id="statutPie"></canvas>
    </div>
  </div>
  <div class="col-md-6 mb-4">
    <div class="card shadow-sm p-3">
      <h5 class="text-center">üë®‚Äçüíª Statistiques Techniciens</h5>
      <canvas id="topTechBar"></canvas>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-4">
    <div class="card shadow-sm p-3">
      <h5 class="text-center">üìÖ Tickets cr√©√©s par Mois</h5>
      <canvas id="ticketsMois"></canvas>
    </div>
  </div>
  <div class="col-md-6 mb-4">
    <div class="card shadow-sm p-3">
      <h5 class="text-center">‚è±Ô∏è Temps Moyen de R√©solution</h5>
      <canvas id="tempsMoyenTech"></canvas>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12 mb-4">
    <div class="card shadow-sm p-3">
      <h5 class="text-center">üè¢ Tickets par Client (Top 5)</h5>
      <canvas id="ticketsClient"></canvas>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12 mb-4">
    <div class="card shadow-sm p-3">
      <h5 class="text-center">‚è±Ô∏è Temps Pass√© vs Temps Factur√© (Techniciens)</h5>
      <canvas id="tempsPasseFacture"></canvas>
    </div>
  </div>
</div>

<!-- üöÄ Scripts Chart.js + ChartDataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
const animationOptions = {
  animations: {
    tension: {
      duration: 1000,
      easing: 'easeInOutQuad',
      from: 1,
      to: 0,
      loop: false
    }
  }
};

const commonBarOptions = {
  responsive: true,
  plugins: {
    legend: { display: false },
    datalabels: {
      color: '#fff',
      anchor: 'center',
      align: 'center',
      font: { weight: 'bold' },
      formatter: Math.round
    }
  },
  scales: { y: { beginAtZero: true } },
  ...animationOptions
};

// üéØ Pie Chart Statut
new Chart(document.getElementById('statutPie'), {
  type: 'pie',
  data: {
    labels: ['En attente', 'En cours', 'Termin√©'],
    datasets: [{
      data: [
        {{ statut_counts['En attente'] }},
        {{ statut_counts['En cours'] }},
        {{ statut_counts['Termin√©'] }}
      ],
      backgroundColor: ['#6c757d', '#0d6efd', '#198754'],
      borderColor: '#fff',
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'bottom' },
      datalabels: {
        color: '#fff',
        font: { weight: 'bold' },
        formatter: (value, context) => {
          const total = context.chart.data.datasets[context.datasetIndex].data.reduce((a, b) => a + b, 0);
          return total ? `${value} (${(value / total * 100).toFixed(1)}%)` : '';
        }
      }
    },
    ...animationOptions
  },
  plugins: [ChartDataLabels]
});

// üë®‚Äçüíª Top Techniciens
new Chart(document.getElementById('topTechBar'), {
  type: 'bar',
  data: {
    labels: [{% for tech, count in top_intervenants %}"{{ tech }}",{% endfor %}],
    datasets: [{
      label: 'Tickets trait√©s',
      data: [{% for tech, count in top_intervenants %}{{ count }},{% endfor %}],
      backgroundColor: '#0dcaf0'
    }]
  },
  options: commonBarOptions,
  plugins: [ChartDataLabels]
});

// üìÖ Tickets par Mois
new Chart(document.getElementById('ticketsMois'), {
  type: 'line',
  data: {
    labels: [{% for mois, count in tickets_par_mois %}"{{ mois }}",{% endfor %}],
    datasets: [{
      label: 'Tickets',
      data: [{% for mois, count in tickets_par_mois %}{{ count }},{% endfor %}],
      borderColor: '#0d6efd',
      backgroundColor: '#0d6efd',
      fill: false,
      tension: 0.4
    }]
  },
  options: {
    responsive: true,
    plugins: { datalabels: { display: false } },
    scales: { y: { beginAtZero: true } },
    ...animationOptions
  }
});

// ‚è±Ô∏è Temps Moyen R√©solution
new Chart(document.getElementById('tempsMoyenTech'), {
  type: 'bar',
  data: {
    labels: [{% for tech, temps in temps_moyen_intervenants %}"{{ tech }}",{% endfor %}],
    datasets: [{
      label: 'Temps moyen (min)',
      data: [{% for tech, temps in temps_moyen_intervenants %}{{ temps|round(1) }},{% endfor %}],
      backgroundColor: '#ffc107'
    }]
  },
  options: commonBarOptions,
  plugins: [ChartDataLabels]
});

// üè¢ Tickets par Client
new Chart(document.getElementById('ticketsClient'), {
  type: 'bar',
  data: {
    labels: [{% for client, count in tickets_par_client %}"{{ client }}",{% endfor %}],
    datasets: [{
      label: 'Tickets cr√©√©s',
      data: [{% for client, count in tickets_par_client %}{{ count }},{% endfor %}],
      backgroundColor: '#6610f2'
    }]
  },
  options: commonBarOptions,
  plugins: [ChartDataLabels]
});

// ‚è±Ô∏è Temps Pass√© vs Temps Factur√©
new Chart(document.getElementById('tempsPasseFacture'), {
  type: 'bar',
  data: {
    labels: [{% for tech in temps_passe_intervenants.keys() %}"{{ tech }}",{% endfor %}],
    datasets: [
      {
        label: 'Temps Pass√© (min)',
        data: [{% for tech, value in temps_passe_intervenants.items() %}{{ value }},{% endfor %}],
        backgroundColor: '#0d6efd'
      },
      {
        label: 'Temps Factur√© (min)',
        data: [{% for tech, value in temps_facture_intervenants.items() %}{{ value }},{% endfor %}],
        backgroundColor: '#198754'
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'bottom' },
      datalabels: {
        color: '#fff',
        anchor: 'end',
        align: 'start',
        font: { weight: 'bold' }
      }
    },
    scales: { y: { beginAtZero: true } },
    ...animationOptions
  },
  plugins: [ChartDataLabels]
});
</script>

{% endblock %}
